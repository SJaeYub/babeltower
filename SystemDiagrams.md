# Babel Tower - 시스템 관계도 및 게임 플로우

## 📊 시스템 아키텍처 다이어그램

```
┌─────────────────────────────────────────────────────────────────┐
│                        GAME MANAGER (싱글톤)                      │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐        │
│  │ SaveMgr  │  │ AudioMgr │  │  UIMgr   │  │ InputMgr │        │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘        │
└─────────────────────────────────────────────────────────────────┘
                                  │
                    ┌─────────────┼─────────────┐
                    ▼             ▼             ▼
         ┌──────────────┐  ┌──────────┐  ┌────────────┐
         │ TownScene    │  │ Dungeon  │  │ BabelTower │
         │              │  │ Scene    │  │   Scene    │
         └──────────────┘  └──────────┘  └────────────┘
                │                 │              │
      ┌─────────┼─────────┐      │              │
      ▼         ▼         ▼      ▼              ▼
  [대장간]  [상점]  [포탈]  [Random    [Tower Floor
                           Generator]   System]
```

## 🔄 게임 플레이 플로우 차트

```
                    [게임 시작]
                         │
                         ▼
              ┌──────────────────┐
              │  캐릭터 선택/생성   │
              │ (전사/마법사/도적/궁수) │
              └──────────────────┘
                         │
                         ▼
              ┌──────────────────┐
              │    마을 (허브)    │ ←──────────┐
              │                  │            │
              │ • 대장간         │            │
              │ • 상점           │            │
              │ • 던전 포탈       │            │
              │ • 바벨탑 포탈     │            │
              └──────────────────┘            │
                    │        │                │
          ┌─────────┘        └─────────┐      │
          ▼                            ▼      │
┌──────────────────┐         ┌──────────────────┐
│   던전 입장       │         │  바벨탑 입장      │
│                  │         │                  │
│ • 난이도 선택    │         │ • 현재 기록 확인  │
│ • 랜덤 맵 생성   │         │ • 층 시작         │
└──────────────────┘         └──────────────────┘
          │                            │
          ▼                            ▼
┌──────────────────┐         ┌──────────────────┐
│   전투/사냥       │         │   층별 도전       │
│                  │         │                  │
│ • 몬스터 처치    │         │ • 제한시간 내     │
│ • 아이템 획득    │         │   적 처치         │
│ • 경험치/골드    │         │ • 보스 등장(5층마다)│
│ • 5-10분 플레이  │         │ • 다음 층 진입    │
└──────────────────┘         └──────────────────┘
          │                            │
          ▼                            ▼
┌──────────────────┐         ┌──────────────────┐
│  던전 클리어/퇴장 │         │ 실패 or 신기록   │
└──────────────────┘         └──────────────────┘
          │                            │
          └────────────────┬───────────┘
                           │
                           ▼
                  ┌──────────────────┐
                  │   보상 획득       │
                  │                  │
                  │ • 아이템         │
                  │ • 골드           │
                  │ • 경험치         │
                  └──────────────────┘
                           │
                           └─────────────────────┘
```

## ⚔️ 전투 시스템 플로우

```
            [플레이어 vs 몬스터]
                     │
       ┌─────────────┼─────────────┐
       ▼             ▼             ▼
   [이동]       [기본공격]      [스킬사용]
                     │             │
                     ▼             ▼
              ┌───────────────────────┐
              │   데미지 계산          │
              │                       │
              │ 1. 기본공격력 - 방어력 │
              │ 2. 치명타 판정         │
              │ 3. 스킬 배율 적용      │
              └───────────────────────┘
                          │
                          ▼
              ┌───────────────────────┐
              │   적용 및 피드백       │
              │                       │
              │ • HP 감소             │
              │ • 데미지 텍스트 표시   │
              │ • 피격 이펙트         │
              │ • 넉백/상태이상        │
              └───────────────────────┘
                          │
                ┌─────────┴─────────┐
                ▼                   ▼
         [적 HP > 0]          [적 HP = 0]
          계속 전투               사망 처리
                                    │
                          ┌─────────┴─────────┐
                          ▼                   ▼
                    [경험치 획득]        [아이템 드롭]
                          │                   │
                          └─────────┬─────────┘
                                    ▼
                              [레벨업 체크]
```

## 🎒 아이템 시스템 플로우

```
                  [아이템 획득]
                       │
         ┌─────────────┼─────────────┐
         ▼             ▼             ▼
    [장비템]      [소비템]      [재료템]
         │             │             │
         ▼             ▼             ▼
┌─────────────┐ ┌──────────┐ ┌──────────────┐
│ 인벤토리에  │ │즉시사용or│ │ 제작/강화용  │
│ 추가        │ │인벤토리  │ │ 보관         │
└─────────────┘ └──────────┘ └──────────────┘
         │
         ▼
┌─────────────────────┐
│   플레이어 선택      │
│                     │
│ 1. 장착 → 스탯 증가 │
│ 2. 판매 → 골드 획득 │
│ 3. 분해 → 재료 획득 │
│ 4. 강화 → 성능 향상 │
└─────────────────────┘
```

## 🔨 대장간 시스템 플로우

```
         [대장간 방문]
               │
    ┌──────────┼──────────┐
    ▼          ▼          ▼
[제작]      [강화]      [분해]
    │          │          │
    ▼          ▼          ▼
레시피    장비선택    장비선택
선택        │          │
    │       ▼          ▼
    ▼    재료+골드    재료획득
재료확인   소모         │
    │       │          │
    ▼       ▼          ▼
골드소모  확률판정    인벤추가
    │    (성공/실패)
    ▼       │
장비획득    ▼
         성공시
        강화수치+1
```

## 🗼 바벨탑 시스템 상세 플로우

```
              [바벨탑 입장]
                    │
                    ▼
          ┌─────────────────┐
          │  현재 층 시작    │
          │                 │
          │ • 제한시간 설정  │
          │ • 몬스터 스폰    │
          └─────────────────┘
                    │
                    ▼
          ┌─────────────────┐
          │   전투 진행      │
          └─────────────────┘
                    │
        ┌───────────┼───────────┐
        ▼           ▼           ▼
   [시간초과]  [플레이어사망] [적전멸]
        │           │           │
        ▼           ▼           ▼
    [실패]       [실패]      [성공]
        │           │           │
        └───────────┴───────────┘
                    │
          ┌─────────┴─────────┐
          ▼                   ▼
    [최종 기록]          [다음 층 진입]
    저장 및 보상              │
          │                   │
          ▼                   ▼
    [마을 귀환]      ┌─────────────────┐
                    │  5층 단위 체크   │
                    └─────────────────┘
                            │
                  ┌─────────┴─────────┐
                  ▼                   ▼
            [일반 층]            [보스 층]
                  │                   │
                  ▼                   ▼
            몬스터 무리           유니크 보스
            +시간 감소            +보상 증가
                  │                   │
                  └─────────┬─────────┘
                            │
                            ▼
                      [층 클리어]
                            │
                    (반복: 다음 층)
```

## 🎯 몬스터 AI 상태 머신

```
                [Idle]
                  │
                  ▼
          플레이어 감지?
            ┌──No──┐
            │      │
            ▼      │
         [Patrol] │
            │      │
            ▼      │
        감지 체크──┘
            │
           Yes
            │
            ▼
         [Chase]
            │
            ▼
     공격 범위 내?
            │
           Yes
            │
            ▼
        [Attack]
            │
            ▼
     쿨다운 대기
            │
            ▼
     타겟 추적 계속?
        ┌──No──┐
        │      │
        ▼      │
     [Idle]   Yes
              │
              └─→ [Chase]
```

## 💾 데이터 흐름도

```
┌─────────────┐
│  게임 시작  │
└─────────────┘
       │
       ▼
 세이브 파일
   존재?
    │ │
  Yes│ No
    │ │
    ▼ ▼
 [Load] [New]
    │   │
    └───┴─→ [GameManager]
              초기화
                │
                ▼
         ┌─────────────┐
         │ 게임 진행   │
         │             │
         │ • 전투      │
         │ • 아이템    │
         │ • 진행도    │
         └─────────────┘
                │
                ▼
         자동 저장 (Auto)
         수동 저장 (Manual)
                │
                ▼
         ┌─────────────┐
         │ JSON 직렬화 │
         └─────────────┘
                │
                ▼
         파일 시스템 저장
         PlayerPrefs 저장
```

## 📈 캐릭터 성장 시스템

```
         [경험치 획득]
                │
                ▼
         레벨업 조건?
                │
               Yes
                │
                ▼
         ┌─────────────┐
         │  레벨 상승  │
         │             │
         │ • 스탯 증가 │
         │ • HP/MP 회복│
         └─────────────┘
                │
                ▼
         새 스킬 해금?
                │
           ┌────┴────┐
          Yes        No
           │          │
           ▼          │
     스킬 추가        │
           │          │
           └────┬─────┘
                │
                ▼
         UI 업데이트
```

## 🎲 아이템 드랍 확률 시스템

```
     [몬스터 사망]
            │
            ▼
     드랍 테이블 확인
            │
            ▼
   ┌─────────────────┐
   │ 아이템별 확률   │
   │                 │
   │ 1. 골드 (100%)  │
   │ 2. 재료 (60%)   │
   │ 3. 장비 (30%)   │
   └─────────────────┘
            │
            ▼ (장비 드랍시)
   ┌─────────────────┐
   │  등급 롤링      │
   │                 │
   │ Common: 70%     │
   │ Rare: 25%       │
   │ Epic: 4%        │
   │ Legendary: 1%   │
   └─────────────────┘
            │
            ▼
     월드에 스폰
            │
            ▼
     플레이어 획득
```

## 🔊 오디오 시스템 구조

```
┌────────────────────────┐
│    Audio Manager       │
├────────────────────────┤
│                        │
│  BGM Source (단일)     │
│  ├─ Town BGM          │
│  ├─ Dungeon BGM       │
│  ├─ Tower BGM         │
│  └─ Boss BGM          │
│                        │
│  SFX Source (풀링)     │
│  ├─ Attack Sounds     │
│  ├─ Skill Sounds      │
│  ├─ UI Sounds         │
│  └─ Ambient Sounds    │
└────────────────────────┘
```

## 🎨 레이어 구조

```
[렌더링 순서]
┌────────────────┐  최상단
│   UI Layer     │  (100)
├────────────────┤
│  Effect Layer  │  (50)
├────────────────┤
│ Character Layer│  (10)
├────────────────┤
│  Object Layer  │  (5)
├────────────────┤
│  Ground Layer  │  (0)
└────────────────┘  최하단
```

## 🗺️ 던전 맵 생성 알고리즘

```
[시작]
   │
   ▼
맵 크기 결정
   │
   ▼
┌──────────────┐
│ BSP 분할     │
│              │
│ 1. 큰 영역   │
│ 2. 재귀 분할 │
│ 3. 방 생성   │
└──────────────┘
   │
   ▼
┌──────────────┐
│ 복도 연결    │
│              │
│ A* 경로 찾기 │
│ 좌표 보정    │
└──────────────┘
   │
   ▼
┌──────────────┐
│ 오브젝트 배치│
│              │
│ • 시작 지점  │
│ • 출구       │
│ • 몬스터     │
│ • 아이템 상자│
└──────────────┘
   │
   ▼
타일 렌더링
   │
   ▼
[완료]
```

---

## 📝 시스템 간 상호작용 매트릭스

| From \ To | Player | Monster | Inventory | UI | Audio |
|-----------|--------|---------|-----------|----|----|
| **Player** | ✓ | Attack | Add/Remove | Update | Trigger |
| **Monster** | Attack | - | Drop | DmgText | Trigger |
| **Inventory** | Equip | - | ✓ | Update | Trigger |
| **UI** | Control | - | Display | ✓ | Trigger |
| **Input** | Control | - | Open | Navigate | - |

---

## 🔑 핵심 이벤트 시스템

```csharp
// 게임 이벤트
public static event Action<Monster> OnMonsterKilled;
public static event Action<int> OnPlayerLevelUp;
public static event Action<Item> OnItemAcquired;
public static event Action<int> OnGoldChanged;
public static event Action<int> OnFloorCompleted;

// 전투 이벤트
public static event Action<Character, float> OnDamageTaken;
public static event Action<Character> OnCharacterDeath;
public static event Action<Skill> OnSkillCast;

// UI 이벤트
public static event Action OnInventoryOpened;
public static event Action OnInventoryClosed;
```

이 시스템 관계도를 기반으로 각 컴포넌트들이 어떻게 연결되는지 명확하게 이해할 수 있습니다.
